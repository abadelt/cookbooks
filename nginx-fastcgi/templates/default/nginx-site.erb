<%- @servers.each do |s| %>
server {

        <%- if  s[:ip].nil? %>
        listen <%= s[:port] %>;
        <%- else %>
        listen <%= "#{s[:ip]}:#{s[:port]}" %>;
        <%- end %>
        
        server_name  <%= s[:server_name] %> <%= s[:server_alias].join(' ') %>;
        <%- if s[:ssl] == true %>
        include <%= s[:ssl_include_path] %>;
        <%- end %>
        expires <%= @expires %>;

        <%- if s[:redirect].nil? || s[:redirect].empty? %>
        location / {
            include fastcgi_params;
            fastcgi_pass  unix:<%= @socket %>;
        <%- if s[:ssl] == true %>
            fastcgi_param  HTTPS on;
        <%- end %>
            # We also set some headers to prevent proxies
            add_header Pragma "no-cache";
            add_header Cache-control "no-cache, must-revalidate, private, no-store";
            expires -1s;

            access_log /var/log/nginx/<%= @site_name %>.access.log;
            error_log  /var/log/nginx/<%= @site_name %>.error.log;
        }
        
        <%- s[:static].each do |st| %>
        location <%= st[:location] %> {
            add_header Cache-control public;
            root <%= st[:root] %>;
            expires <%= st[:expires] || '-1s' %>;
        }            
        <%- end %>
        <%- else %>
        rewrite  ^ <%= s[:redirect] %>://$server_name$request_uri? permanent;
        <%- end %>
}
<%- end %>

